var BGem3={};BGem3.Scene=function(){this.objs=[],this.add=function(e){this.objs.push(e)},this.action=function(){}},BGem3.Camera=function(){this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0},this.focalLength=focalLength,this.friction=.2,this.w=0,this.a=0,this.s=0,this.d=0,this.u=0,this.o=0,this.l=0,this.r=0},BGem3.Obj3D=function(e){this.mesh=e,this.transform=[],this.vertices2=[],this.sgPosition={x:0,y:0,z:0},this.gPosition={x:0,y:0,z:0},this.lPosition={x:0,y:0,z:0},this.gRotation={x:0,y:0,z:0},this.lRotation={x:0,y:0,z:0},this.applyGlobalRot=!1,this.lockRotation=!1,this.visible=!0,this.shade=!0,this.shine=!0},BGem3.Mesh=function(){this.vertices=[],this.faces=[],this.stroke=!0,this.strokeStyle="",this.fill=!1,this.fillStyle="",this.textured=!1},BGem3.CubeMesh=function(e){BGem3.Mesh.apply(this,arguments),this.size=e.size,this.vertices=[{x:.1,y:.1,z:.1},{x:this.size,y:-this.size,z:-this.size},{x:-this.size,y:-this.size,z:-this.size},{x:-this.size,y:this.size,z:-this.size},{x:this.size,y:this.size,z:-this.size},{x:this.size,y:-this.size,z:this.size},{x:-this.size,y:-this.size,z:this.size},{x:-this.size,y:this.size,z:this.size},{x:this.size,y:this.size,z:this.size}],this.faces=[[1,2,3,4,[102,45,145,1],!0,texture,!0],[5,1,4,8,[102,45,145,1],!0,texture,!1],[6,5,8,7,[102,45,145,1],!0,texture,!1],[2,6,7,3,[102,45,145,1],!0,texture,!1],[5,6,2,1,[102,45,145,1],!0,texture,!1],[4,3,7,8,[102,45,145,1],!0,texture,!1]]},BGem3.CubeMesh.prototype=new BGem3.Mesh,BGem3.AnchorPt=function(){BGem3.Mesh.apply(this,arguments),this.size=6,this.vertices=[{x:.1,y:.1,z:.1},{x:this.size,y:-this.size,z:-this.size},{x:-this.size,y:-this.size,z:-this.size},{x:-this.size,y:this.size,z:-this.size},{x:this.size,y:this.size,z:-this.size}],this.faces=[[1,2,3,4,[102,45,145,1],!0,texture,!0]],this.lockRotation=!0},BGem3.AnchorPt.prototype=new BGem3.Mesh,BGem3.Renderer=function(){this.fps=fps,this.interval=1/this.fps*1e3,this.centerX=maxWidth/2,this.centerY=maxHeight/2,this.render=function(){for(var e=0;e<scene.objs.length;e++){renderer.debug=[],scene.objs[e].transform=[],scene.objs[e].vertices2=[];for(var t=0;t<scene.objs[e].mesh.vertices.length;t++){var s=JSON.parse(JSON.stringify(scene.objs[e].mesh.vertices[t]));scene.objs[e].transform.push(s)}}scene.action(),renderer.moveCam(renderer.rotate),renderer.trackFPS+=1},this.moveCam=function(e){var t=BGem3.Math.round2(camera.friction),s=camera.rotation.y;camera.w>0&&(camera.position.z+=Math.cos(s*Math.PI/180)*camera.w,camera.position.x-=Math.sin(s*Math.PI/180)*camera.w,camera.w<1&&(camera.w-=t)),camera.s>0&&(camera.position.z-=Math.cos(s*Math.PI/180)*camera.s,camera.position.x+=Math.sin(s*Math.PI/180)*camera.s,camera.s<1&&(camera.s-=t)),camera.a>0&&(camera.position.z-=Math.sin(s*Math.PI/180)*camera.a,camera.position.x-=Math.cos(s*Math.PI/180)*camera.a,camera.a<1&&(camera.a-=t)),camera.d>0&&(camera.position.z+=Math.sin(s*Math.PI/180)*camera.d,camera.position.x+=Math.cos(s*Math.PI/180)*camera.d,camera.d<1&&(camera.d-=t)),camera.u>0&&(camera.rotation.x+=camera.u,camera.u<1&&(camera.u-=.2)),camera.o>0&&(camera.rotation.x-=camera.o,camera.o<1&&(camera.o-=.2)),camera.l>0&&(camera.rotation.y+=camera.l,camera.l<1&&(camera.l-=.2)),camera.r>0&&(camera.rotation.y-=camera.r,camera.r<1&&(camera.r-=.2)),e("local",renderer.translate)},this.rotate=function(e,t){for(var s=0;s<scene.objs.length;s++){for(var r=0;r<scene.objs[s].transform.length;r++){var a=scene.objs[s].transform[r].x,o=scene.objs[s].transform[r].z,n=BGem3.Math.getAngle(0,0,a,o);angle2="local"==e?n-scene.objs[s].lRotation.y*Math.PI/180:"global"==e?n-scene.objs[s].gRotation.y*Math.PI/180:n-camera.rotation.y*Math.PI/180,angle2>2*Math.PI&&(angle2-=2*Math.PI);var i=BGem3.Math.getDist(0,0,a,o);scene.objs[s].transform[r].x=Math.cos(angle2)*i,scene.objs[s].transform[r].z=Math.sin(angle2)*i}for(var c=0;c<scene.objs[s].transform.length;c++){var a=scene.objs[s].transform[c].x,h=scene.objs[s].transform[c].y,n=BGem3.Math.getAngle(0,0,a,h);angle2="local"==e?n-scene.objs[s].lRotation.z*Math.PI/180:"global"==e?n-scene.objs[s].gRotation.z*Math.PI/180:n-camera.rotation.z*Math.PI/180,angle2>2*Math.PI&&(angle2-=2*Math.PI);var i=BGem3.Math.getDist(0,0,a,h);scene.objs[s].transform[c].x=Math.cos(angle2)*i,scene.objs[s].transform[c].y=Math.sin(angle2)*i}for(var l=0;l<scene.objs[s].transform.length;l++){var h=scene.objs[s].transform[l].y,o=scene.objs[s].transform[l].z,n=BGem3.Math.getAngle(0,0,h,o);angle2="local"==e?n-scene.objs[s].lRotation.x*Math.PI/180:"global"==e?n-scene.objs[s].gRotation.x*Math.PI/180:n-camera.rotation.x*Math.PI/180,angle2>2*Math.PI&&(angle2-=2*Math.PI);var i=BGem3.Math.getDist(0,0,h,o);scene.objs[s].transform[l].y=Math.cos(angle2)*i,scene.objs[s].transform[l].z=Math.sin(angle2)*i}"global"==e&&scene.objs[s].applyGlobalRot&&(scene.objs[s].lRotation={x:0,y:0,z:0},scene.objs[s].applyGlobalRot=!1)}if("local"==e)renderer.debug.push(["f","rotate local"]),t("local",renderer.rotate);else if("global"==e)renderer.debug.push(["f","rotate global"]),t("global",renderer.translate);else{for(var s=0;s<scene.objs.length;s++)if(scene.objs[s].sgPosition.x=JSON.parse(JSON.stringify(scene.objs[s])).transform[0].x,scene.objs[s].sgPosition.y=JSON.parse(JSON.stringify(scene.objs[s])).transform[0].y,scene.objs[s].sgPosition.z=JSON.parse(JSON.stringify(scene.objs[s])).transform[0].z,scene.objs[s].mesh.lockRotation)for(var r=1;r<scene.objs[s].transform.length;r++)scene.objs[s].transform[r].x=scene.objs[s].mesh.vertices[r].x+scene.objs[s].sgPosition.x,scene.objs[s].transform[r].y=scene.objs[s].mesh.vertices[r].y+scene.objs[s].sgPosition.y,scene.objs[s].transform[r].z=scene.objs[s].mesh.vertices[r].z+scene.objs[s].sgPosition.z;renderer.debug.push(["f","rotate camera"]),t(renderer.zSortObjs)}},this.translate=function(e,t){for(var s=0;s<scene.objs.length;s++)for(var r=0;r<scene.objs[s].transform.length;r++)"local"==e?(scene.objs[s].transform[r].x+=scene.objs[s].lPosition.x,scene.objs[s].transform[r].y+=scene.objs[s].lPosition.y,scene.objs[s].transform[r].z+=scene.objs[s].lPosition.z):"global"==e?(scene.objs[s].transform[r].x+=scene.objs[s].gPosition.x,scene.objs[s].transform[r].y+=scene.objs[s].gPosition.y,scene.objs[s].transform[r].z+=scene.objs[s].gPosition.z):(scene.objs[s].transform[r].x-=camera.position.x,scene.objs[s].transform[r].y-=camera.position.y,scene.objs[s].transform[r].z-=camera.position.z);"local"==e?(renderer.debug.push(["f","translate local"]),t("global",renderer.translate)):"global"==e?(renderer.debug.push(["f","translate global"]),t("camera",renderer.rotate)):(renderer.debug.push(["f","translate camera"]),t("camera",renderer.project))},this.project=function(e){for(var t=0;t<scene.objs.length;t++)for(var s=0;s<scene.objs[t].transform.length;s++){var r=camera.focalLength/scene.objs[t].transform[s].z,a={};a.x=scene.objs[t].transform[s].x*r+renderer.centerX,a.y=scene.objs[t].transform[s].y*r+renderer.centerY,scene.objs[t].vertices2.push(a)}e(renderer.draw)},this.zSort=[],this.zSortObjs=function(e){renderer.zSort=[];for(var t=0;t<scene.objs.length;t++)for(var s=0;s<scene.objs[t].mesh.faces.length;s++){var r=JSON.parse(JSON.stringify(scene.objs[t].transform)),a=JSON.parse(JSON.stringify(scene.objs[t].vertices2)),o=JSON.parse(JSON.stringify(scene.objs[t].mesh.faces[s])),n=JSON.parse(JSON.stringify(scene.objs[t].mesh.faces[s][4])),i=scene.objs[t].mesh.faces[s][7]&&scene.objs[t].mesh.textured,c={},h={},l={},m={},b=[c,h,l,m];c.v3=r[o[0]],c.v2=a[o[0]],c.v2.u=640,c.v2.v=0,h.v3=r[o[1]],h.v2=a[o[1]],h.v2.u=0,h.v2.v=0,l.v3=r[o[2]],l.v2=a[o[2]],l.v2.u=0,l.v2.v=360,m.v3=r[o[3]],m.v2=a[o[3]],m.v2.u=640,m.v2.v=360;for(var f=0,u=0;u<b.length;u++)f+=b[u].v3.z;var g=scene.objs[t].visible,v={obj:scene.objs[t],face:o,p1:c,p2:h,p3:l,p4:m,zInd:f,visible:g,fillStyle:n,cull:!1,textured:i};renderer.zSort.push(v)}renderer.zSort.sort(function(e,t){return t.zInd-e.zInd}),e(renderer.updateStats)},this.draw=function(e){if(renderer.skip)return void(renderer.skip=!1);ctx.clearRect(0,0,maxWidth,maxHeight);for(var t=0;t<renderer.zSort.length;t++)if(renderer.zSort[t].visible&&(renderer.backfaceCull(renderer.zSort[t]),!renderer.zSort[t].cull)){var s=BGem3.Math.getNormal(renderer.zSort[t]),r=s.angle,a=1-r/Math.PI,o=1-r/Math.PI*1.2,n=renderer.zSort[t].fillStyle,i=[renderer.zSort[t].p1.v2,renderer.zSort[t].p2.v2,renderer.zSort[t].p3.v2,renderer.zSort[t].p4.v2];ctx.save(),ctx.beginPath(),ctx.moveTo(i[0].x,i[0].y),ctx.lineTo(i[1].x,i[1].y),ctx.lineTo(i[2].x,i[2].y),ctx.lineTo(i[3].x,i[3].y),ctx.lineTo(i[0].x,i[0].y),ctx.closePath();var c=Math.floor(n[0]*a)+Math.floor(n[0]*o+50*o),h=Math.floor(n[1]*a)+Math.floor(n[1]*o+50*o),l=Math.floor(n[2]*a)+Math.floor(n[2]*o+50*o);if(ctx.strokeStyle="rgb("+c+","+h+","+l+")",ctx.stroke(),ctx.fillStyle="rgb("+c+","+h+","+l+")",ctx.fill(),renderer.zSort[t].textured){i=renderer.overDraw(i),ctx.beginPath(),ctx.moveTo(i[0].x,i[0].y),ctx.lineTo(i[1].x,i[1].y),ctx.lineTo(i[2].x,i[2].y),ctx.lineTo(i[3].x,i[3].y),ctx.lineTo(i[0].x,i[0].y),ctx.closePath(),ctx.clip();for(var m=[[0,1,3],[1,2,3]],b=0;b<m.length;b++){var f=m[b],u=f[0],g=f[1],v=f[2],x=i[u].x,d=i[g].x,z=i[v].x,y=i[u].y,p=i[g].y,j=i[v].y,M=i[u].u,P=i[g].u,S=i[v].u,k=i[u].v,G=i[g].v,I=i[v].v,B=M*G+k*S+P*I-G*S-k*P-M*I,w=x*G+k*z+d*I-G*z-k*d-x*I,R=M*d+x*S+P*z-d*S-x*P-M*z,O=M*G*z+k*d*S+x*P*I-x*G*S-k*P*z-M*d*I,N=y*G+k*j+p*I-G*j-k*p-y*I,J=M*p+y*S+P*j-p*S-y*P-M*j,X=M*G*j+k*p*S+y*P*I-y*G*S-k*P*j-M*p*I;ctx.transform(w/B,N/B,R/B,J/B,O/B,X/B),ctx.drawImage(texture,0,0)}ctx.restore()}}e(renderer.post)},this.skip=!0,this.debug=[],this.updateStats=function(e){for(var t="",s=0;s<renderer.debug.length;s++)t+=renderer.debug[s][0]+": "+renderer.debug[s][1]+"<br>";$("#debug").html(t),e()},this.showFPS=!0,this.updateFPS=function(){updateFPS=setInterval(function(){var e="fps: "+renderer.trackFPS;$("#fps").html(e),renderer.trackFPS=0},1e3)},this.trackFPS=0,this.showFPS&&this.updateFPS(),this.backfaceCull=function(e){var t=e.p1.v2,s=e.p2.v2,r=e.p3.v2,a=s.x-t.x,o=s.y-t.y,n=s.x-r.x,i=s.y-r.y,c=a*i-o*n;e.cull=0>c?!0:!1},this.overDraw=function(e){for(var e=e,t=1.03,s=e[0],r=e[1],a=(e[2],e[3],e[2].x-e[0].x),o=e[2].y-e[0].y,n=e[3].x-e[1].x,i=e[3].y-e[1].y,c=o/a,h=i/n,l=s.y-c*s.x,m=r.y-h*r.x,b=(m-l)/(c-h),f=c*b+l,u=0;u<e.length;u++){var g=BGem3.Math.getDist(b,f,e[u].x,e[u].y),v=BGem3.Math.getAngle(b,f,e[u].x,e[u].y),x=g*t;e[u].x=b+Math.cos(v)*x,e[u].y=f+Math.sin(v)*x}return e},this.post=function(){}},BGem3.Controller=function(e){this.div=e.div,this.mouseX=0,this.mouseY=0,this.events={desktop:["mousedown","mousemove","mouseup"],mobile:["touchstart","touchmove","touchend"]},this.bindEvents=function(e){var t="desktop"==e,s=t?this.events.desktop:this.events.mobile;$(this.div).bind(s[0],function(e){controller.mouseX=t?e.pageX:e.originalEvent.touches[0].pageX,controller.mouseY=t?e.pageY:e.originalEvent.touches[0].pageY,$(this).bind(s[1],function(e){for(var s=t?e.pageX-controller.mouseX:e.originalEvent.touches[0].pageX-controller.mouseX,r=t?e.pageY-controller.mouseY:e.originalEvent.touches[0].pageY-controller.mouseY,a=0;a<scene.objs.length;a++)scene.objs[a].gRotation.y-=s/2,scene.objs[a].gRotation.x-=r/2;controller.mouseX=t?e.pageX:e.originalEvent.touches[0].pageX,controller.mouseY=t?e.pageY:e.originalEvent.touches[0].pageY}).bind(s[2],function(){$(this).unbind(s[1]);for(var e=0;e<scene.objs.length;e++)scene.objs[e].applyGlobalRot=!0})})},this.bindEvents("desktop"),this.bindEvents("potato")},BGem3.CameraController=function(){$(window).bind({keydown:function(e){switch(e.keyCode){case 87:camera.w=1;break;case 65:camera.a=1;break;case 83:camera.s=1;break;case 68:camera.d=1;break;case 38:camera.u=1;break;case 40:camera.o=1;break;case 37:camera.l=1;break;case 39:camera.r=1}},keyup:function(e){switch(e.keyCode){case 87:camera.w=.8;break;case 65:camera.a=.8;break;case 83:camera.s=.8;break;case 68:camera.d=.8;break;case 38:camera.u=.8;break;case 40:camera.o=.8;break;case 37:camera.l=.8;break;case 39:camera.r=.8}}})},BGem3.MathFunc=function(){this.getDist=function(e,t,s,r){var a=e-s,o=t-r,n=Math.sqrt(a*a+o*o);return n},this.getAngle=function(e,t,s,r){var a;return s>=e&&r>=t?a=Math.atan((r-t)/(s-e)):e>=s&&r>=t?a=.5*Math.PI-Math.atan((s-e)/(r-t)):e>=s&&t>=r?a=Math.PI+Math.atan((r-t)/(s-e)):s>=e&&t>=r&&(a=1.5*Math.PI-Math.atan((s-e)/(r-t))),a},this.round2=function(e){return Math.round(100*(e+1e-5))/100},this.random=function(e,t){var s=t-e;return Math.floor(Math.random()*s+e)},this.getNormal=function(e){var t={x:100,y:-200,z:50},s=e.p1,r=e.p2,a=e.p3,o=r.v3.x-s.v3.x,n=r.v3.y-s.v3.y,i=r.v3.z-s.v3.z,c=a.v3.x-s.v3.x,h=a.v3.y-s.v3.y,l=r.v3.z-s.v3.z,m=n*l-i*h,b=i*c-o*l,f=o*h-n*c,u=m+.01,g=b+.01,v=f+.01,x=t.x,d=t.y,z=t.z,y=Math.acos((u*x+g*d+v*z)/Math.sqrt((u*u+g*g+v*v)*(x*x+d*d+z*z))),p={x:m,y:b,z:f,angle:y};return p}},BGem3.Math=new BGem3.MathFunc;