var BGem3={};BGem3.Scene=function(){this.objs=[],this.add=function(e){this.objs.push(e)},this.action=function(){}},BGem3.Camera=function(){this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0},this.focalLength=focalLength},BGem3.Obj3D=function(e){this.mesh=e,this.transform=[],this.vertices2=[],this.sgPosition={x:0,y:0,z:0},this.gPosition={x:0,y:0,z:0},this.lPosition={x:0,y:0,z:0},this.gRotation={x:0,y:0,z:0},this.lRotation={x:0,y:0,z:0},this.applyGlobalRot=!1,this.lockRotation=!1,this.visible=!0,this.shade=!0,this.shine=!0},BGem3.Mesh=function(){this.vertices=[],this.faces=[],this.makeTransform=function(){this.transform=JSON.parse(JSON.stringify(this.vertices))},this.stroke=!0,this.strokeStyle="",this.fill=!1,this.fillStyle="",this.textured=!1},BGem3.CubeMesh=function(e){BGem3.Mesh.apply(this,arguments),this.size=e.size,this.vertices=[{x:.1,y:.1,z:.1},{x:this.size,y:-this.size,z:-this.size},{x:-this.size,y:-this.size,z:-this.size},{x:-this.size,y:this.size,z:-this.size},{x:this.size,y:this.size,z:-this.size},{x:this.size,y:-this.size,z:this.size},{x:-this.size,y:-this.size,z:this.size},{x:-this.size,y:this.size,z:this.size},{x:this.size,y:this.size,z:this.size}],this.faces=[[1,2,3,4,[102,45,145,1],!0,texture,!0],[5,1,4,8,[102,45,145,1],!0,texture,!1],[6,5,8,7,[102,45,145,1],!0,texture,!1],[2,6,7,3,[102,45,145,1],!0,texture,!1],[5,6,2,1,[102,45,145,1],!0,texture,!1],[4,3,7,8,[102,45,145,1],!0,texture,!1]],this.makeTransform()},BGem3.CubeMesh.prototype=new BGem3.Mesh,BGem3.AnchorPt=function(){BGem3.Mesh.apply(this,arguments),this.size=6,this.vertices=[{x:.1,y:.1,z:.1},{x:this.size,y:-this.size,z:-this.size},{x:-this.size,y:-this.size,z:-this.size},{x:-this.size,y:this.size,z:-this.size},{x:this.size,y:this.size,z:-this.size}],this.faces=[[1,2,3,4,[102,45,145,1],!0,texture,!0]],this.makeTransform(),this.lockRotation=!0},BGem3.AnchorPt.prototype=new BGem3.Mesh,BGem3.Renderer=function(){this.fps=fps,this.interval=1/this.fps*1e3,this.centerX=maxWidth/2,this.centerY=maxHeight/2,this.render=function(){for(var e=0;e<scene.objs.length;e++){renderer.debug=[],scene.objs[e].transform=[],scene.objs[e].vertices2=[];for(var t=0;t<scene.objs[e].mesh.vertices.length;t++){var s=JSON.parse(JSON.stringify(scene.objs[e].mesh.vertices[t]));scene.objs[e].transform.push(s)}}scene.action(),renderer.moveCam(renderer.rotate),renderer.trackFPS+=1},this.moveCam=function(e){cameraController.w&&(camera.position.z+=1),cameraController.a&&(camera.position.x-=1),cameraController.s&&(camera.position.z-=1),cameraController.d&&(camera.position.x+=1),cameraController.u&&(camera.rotation.x+=1),cameraController.o&&(camera.rotation.x-=1),cameraController.l&&(camera.rotation.y+=1),cameraController.r&&(camera.rotation.y-=1),e("local",renderer.translate)},this.rotate=function(e,t){for(var s=0;s<scene.objs.length;s++){for(var r=0;r<scene.objs[s].transform.length;r++){var o=scene.objs[s].transform[r].y,n=scene.objs[s].transform[r].z,a=BGem3.Math.getAngle(0,0,o,n);switch(e){case"local":angle2=a-scene.objs[s].lRotation.x*Math.PI/180;break;case"global":angle2=a-scene.objs[s].gRotation.x*Math.PI/180;break;case"camera":angle2=a-camera.rotation.x*Math.PI/180}angle2>2*Math.PI&&(angle2-=2*Math.PI);var i=BGem3.Math.getDist(0,0,o,n);scene.objs[s].transform[r].y=Math.cos(angle2)*i,scene.objs[s].transform[r].z=Math.sin(angle2)*i}for(var c=0;c<scene.objs[s].transform.length;c++){var l=scene.objs[s].transform[c].x,n=scene.objs[s].transform[c].z,a=BGem3.Math.getAngle(0,0,l,n);switch(e){case"local":angle2=a-scene.objs[s].lRotation.y*Math.PI/180;break;case"global":angle2=a-scene.objs[s].gRotation.y*Math.PI/180;break;case"camera":angle2=a-camera.rotation.y*Math.PI/180}angle2>2*Math.PI&&(angle2-=2*Math.PI);var i=BGem3.Math.getDist(0,0,l,n);scene.objs[s].transform[c].x=Math.cos(angle2)*i,scene.objs[s].transform[c].z=Math.sin(angle2)*i}for(var h=0;h<scene.objs[s].transform.length;h++){var l=scene.objs[s].transform[h].x,o=scene.objs[s].transform[h].y,a=BGem3.Math.getAngle(0,0,l,o);switch(e){case"local":angle2=a-scene.objs[s].lRotation.z*Math.PI/180;break;case"global":angle2=a-scene.objs[s].gRotation.z*Math.PI/180;break;case"camera":angle2=a-camera.rotation.z*Math.PI/180}angle2>2*Math.PI&&(angle2-=2*Math.PI);var i=BGem3.Math.getDist(0,0,l,o);scene.objs[s].transform[h].x=Math.cos(angle2)*i,scene.objs[s].transform[h].y=Math.sin(angle2)*i}"global"==e&&scene.objs[s].applyGlobalRot&&(scene.objs[s].lRotation={x:0,y:0,z:0},scene.objs[s].applyGlobalRot=!1)}"local"==e?(renderer.debug.push(["f","rotate local"]),t("local",renderer.rotate)):"global"==e?(renderer.debug.push(["f","rotate global"]),t("global",renderer.translate)):(renderer.debug.push(["f","rotate camera"]),t(renderer.zSortObjs))},this.translate=function(e,t){for(var s=0;s<scene.objs.length;s++)for(var r=0;r<scene.objs[s].transform.length;r++)"local"==e?(scene.objs[s].transform[r].x+=scene.objs[s].lPosition.x,scene.objs[s].transform[r].y+=scene.objs[s].lPosition.y,scene.objs[s].transform[r].z+=scene.objs[s].lPosition.z):"global"==e?(scene.objs[s].transform[r].x+=scene.objs[s].gPosition.x,scene.objs[s].transform[r].y+=scene.objs[s].gPosition.y,scene.objs[s].transform[r].z+=scene.objs[s].gPosition.z):(scene.objs[s].transform[r].x-=camera.position.x,scene.objs[s].transform[r].y-=camera.position.y,scene.objs[s].transform[r].z-=camera.position.z);if("local"==e)renderer.debug.push(["f","translate local"]),t("global",renderer.translate);else if("global"==e){for(var s=0;s<scene.objs.length;s++)if(scene.objs[s].sgPosition.x=JSON.parse(JSON.stringify(scene.objs[s])).transform[0].x,scene.objs[s].sgPosition.y=JSON.parse(JSON.stringify(scene.objs[s])).transform[0].y,scene.objs[s].sgPosition.z=JSON.parse(JSON.stringify(scene.objs[s])).transform[0].z,scene.objs[s].mesh.lockRotation)for(var r=1;r<scene.objs[s].transform.length;r++)scene.objs[s].transform[r].x=scene.objs[s].mesh.vertices[r].x+scene.objs[s].sgPosition.x,scene.objs[s].transform[r].y=scene.objs[s].mesh.vertices[r].y+scene.objs[s].sgPosition.y,scene.objs[s].transform[r].z=scene.objs[s].mesh.vertices[r].z+scene.objs[s].sgPosition.z;renderer.debug.push(["f","translate global"]),t("camera",renderer.rotate)}else renderer.debug.push(["f","translate camera"]),t("camera",renderer.project)},this.project=function(e){for(var t=0;t<scene.objs.length;t++)for(var s=0;s<scene.objs[t].transform.length;s++){var r=camera.focalLength/scene.objs[t].transform[s].z,o={};o.x=scene.objs[t].transform[s].x*r+renderer.centerX,o.y=scene.objs[t].transform[s].y*r+renderer.centerY,scene.objs[t].vertices2.push(o)}e(renderer.draw)},this.zSort=[],this.zSortObjs=function(e){renderer.zSort=[];for(var t=0;t<scene.objs.length;t++)for(var s=0;s<scene.objs[t].mesh.faces.length;s++){var r=JSON.parse(JSON.stringify(scene.objs[t].transform)),o=JSON.parse(JSON.stringify(scene.objs[t].vertices2)),n=JSON.parse(JSON.stringify(scene.objs[t].mesh.faces[s])),a=JSON.parse(JSON.stringify(scene.objs[t].mesh.faces[s][4])),i=scene.objs[t].mesh.faces[s][7]&&scene.objs[t].mesh.textured,c={},l={},h={},m={},b=[c,l,h,m];c.v3=r[n[0]],c.v2=o[n[0]],c.v2.u=640,c.v2.v=0,l.v3=r[n[1]],l.v2=o[n[1]],l.v2.u=0,l.v2.v=0,h.v3=r[n[2]],h.v2=o[n[2]],h.v2.u=0,h.v2.v=360,m.v3=r[n[3]],m.v2=o[n[3]],m.v2.u=640,m.v2.v=360;for(var f=0,g=0;g<b.length;g++)f+=b[g].v3.z;var u=scene.objs[t].visible,v={obj:scene.objs[t],face:n,p1:c,p2:l,p3:h,p4:m,zInd:f,visible:u,fillStyle:a,cull:!1,textured:i};renderer.zSort.push(v)}renderer.zSort.sort(function(e,t){return t.zInd-e.zInd}),e(renderer.updateStats)},this.draw=function(e){if(renderer.skip)return void(renderer.skip=!1);ctx.clearRect(0,0,maxWidth,maxHeight);for(var t=0;t<renderer.zSort.length;t++)if(renderer.zSort[t].visible&&(renderer.backfaceCull(renderer.zSort[t]),!renderer.zSort[t].cull)){var s=BGem3.Math.getNormal(renderer.zSort[t]),r=s.angle,o=1-r/Math.PI,n=1-r/Math.PI*1.2,a=renderer.zSort[t].fillStyle,i=[renderer.zSort[t].p1.v2,renderer.zSort[t].p2.v2,renderer.zSort[t].p3.v2,renderer.zSort[t].p4.v2];ctx.save(),ctx.beginPath(),ctx.moveTo(i[0].x,i[0].y),ctx.lineTo(i[1].x,i[1].y),ctx.lineTo(i[2].x,i[2].y),ctx.lineTo(i[3].x,i[3].y),ctx.lineTo(i[0].x,i[0].y),ctx.closePath();var c=Math.floor(a[0]*o)+Math.floor(a[0]*n+50*n),l=Math.floor(a[1]*o)+Math.floor(a[1]*n+50*n),h=Math.floor(a[2]*o)+Math.floor(a[2]*n+50*n);if(ctx.strokeStyle="rgb("+c+","+l+","+h+")",ctx.stroke(),ctx.fillStyle="rgb("+c+","+l+","+h+")",ctx.fill(),renderer.zSort[t].textured){i=renderer.overDraw(i),ctx.beginPath(),ctx.moveTo(i[0].x,i[0].y),ctx.lineTo(i[1].x,i[1].y),ctx.lineTo(i[2].x,i[2].y),ctx.lineTo(i[3].x,i[3].y),ctx.lineTo(i[0].x,i[0].y),ctx.closePath(),ctx.clip();for(var m=[[0,1,3],[1,2,3]],b=0;b<m.length;b++){var f=m[b],g=f[0],u=f[1],v=f[2],x=i[g].x,z=i[u].x,d=i[v].x,y=i[g].y,j=i[u].y,p=i[v].y,M=i[g].u,S=i[u].u,P=i[v].u,k=i[g].v,C=i[u].v,G=i[v].v,B=M*C+k*P+S*G-C*P-k*S-M*G,I=x*C+k*d+z*G-C*d-k*z-x*G,w=M*z+x*P+S*d-z*P-x*S-M*d,O=M*C*d+k*z*P+x*S*G-x*C*P-k*S*d-M*z*G,N=y*C+k*p+j*G-C*p-k*j-y*G,R=M*j+y*P+S*p-j*P-y*S-M*p,J=M*C*p+k*j*P+y*S*G-y*C*P-k*S*p-M*j*G;ctx.transform(I/B,N/B,w/B,R/B,O/B,J/B),ctx.drawImage(texture,0,0)}ctx.restore()}}e(renderer.post)},this.skip=!0,this.debug=[],this.updateStats=function(e){for(var t="",s=0;s<renderer.debug.length;s++)t+=renderer.debug[s][0]+": "+renderer.debug[s][1]+"<br>";$("#debug").html(t),e()},this.showFPS=!0,this.updateFPS=function(){updateFPS=setInterval(function(){var e="fps: "+renderer.trackFPS;$("#fps").html(e),renderer.trackFPS=0},1e3)},this.trackFPS=0,this.showFPS&&this.updateFPS(),this.backfaceCull=function(e){var t=e.p1.v2,s=e.p2.v2,r=e.p3.v2,o=s.x-t.x,n=s.y-t.y,a=s.x-r.x,i=s.y-r.y,c=o*i-n*a;e.cull=0>c?!0:!1},this.overDraw=function(e){for(var e=e,t=1.03,s=e[0],r=e[1],o=(e[2],e[3],e[2].x-e[0].x),n=e[2].y-e[0].y,a=e[3].x-e[1].x,i=e[3].y-e[1].y,c=n/o,l=i/a,h=s.y-c*s.x,m=r.y-l*r.x,b=(m-h)/(c-l),f=c*b+h,g=0;g<e.length;g++){var u=BGem3.Math.getDist(b,f,e[g].x,e[g].y),v=BGem3.Math.getAngle(b,f,e[g].x,e[g].y),x=u*t;e[g].x=b+Math.cos(v)*x,e[g].y=f+Math.sin(v)*x}return e},this.post=function(){}},BGem3.Controller=function(e){this.div=e.div,this.mouseX=0,this.mouseY=0,this.events={desktop:["mousedown","mousemove","mouseup"],mobile:["touchstart","touchmove","touchend"]},this.bindEvents=function(e){var t="desktop"==e,s=t?this.events.desktop:this.events.mobile;$(this.div).bind(s[0],function(e){controller.mouseX=t?e.pageX:e.originalEvent.touches[0].pageX,controller.mouseY=t?e.pageY:e.originalEvent.touches[0].pageY,$(this).bind(s[1],function(e){for(var s=t?e.pageX-controller.mouseX:e.originalEvent.touches[0].pageX-controller.mouseX,r=t?e.pageY-controller.mouseY:e.originalEvent.touches[0].pageY-controller.mouseY,o=0;o<scene.objs.length;o++)scene.objs[o].gRotation.y-=s/2,scene.objs[o].gRotation.x-=r/2;controller.mouseX=t?e.pageX:e.originalEvent.touches[0].pageX,controller.mouseY=t?e.pageY:e.originalEvent.touches[0].pageY}).bind(s[2],function(){$(this).unbind(s[1]);for(var e=0;e<scene.objs.length;e++)scene.objs[e].applyGlobalRot=!0})})},this.bindEvents("desktop"),this.bindEvents("potato")},BGem3.CameraController=function(){this.w=!1,this.a=!1,this.s=!1,this.d=!1,this.u=!1,this.o=!1,this.l=!1,this.r=!1,$(window).bind({keydown:function(e){switch(e.keyCode){case 87:cameraController.w=!0;break;case 65:cameraController.a=!0;break;case 83:cameraController.s=!0;break;case 68:cameraController.d=!0;break;case 38:cameraController.u=!0;break;case 40:cameraController.o=!0;break;case 37:cameraController.l=!0;break;case 39:cameraController.r=!0}},keyup:function(e){switch(e.keyCode){case 87:cameraController.w=!1;break;case 65:cameraController.a=!1;break;case 83:cameraController.s=!1;break;case 68:cameraController.d=!1;break;case 38:cameraController.u=!1;break;case 40:cameraController.o=!1;break;case 37:cameraController.l=!1;break;case 39:cameraController.r=!1}}})},BGem3.MathFunc=function(){this.getDist=function(e,t,s,r){var o=e-s,n=t-r,a=Math.sqrt(o*o+n*n);return a},this.getAngle=function(e,t,s,r){var o;return s>=e&&r>=t?o=Math.atan((r-t)/(s-e)):e>=s&&r>=t?o=.5*Math.PI-Math.atan((s-e)/(r-t)):e>=s&&t>=r?o=Math.PI+Math.atan((r-t)/(s-e)):s>=e&&t>=r&&(o=1.5*Math.PI-Math.atan((s-e)/(r-t))),o},this.round2=function(e){return Math.round(100*(e+1e-5))/100},this.random=function(e,t){var s=t-e;return Math.floor(Math.random()*s+e)},this.getNormal=function(e){var t={x:100,y:-200,z:50},s=e.p1,r=e.p2,o=e.p3,n=r.v3.x-s.v3.x,a=r.v3.y-s.v3.y,i=r.v3.z-s.v3.z,c=o.v3.x-s.v3.x,l=o.v3.y-s.v3.y,h=r.v3.z-s.v3.z,m=a*h-i*l,b=i*c-n*h,f=n*l-a*c,g=m+.01,u=b+.01,v=f+.01,x=t.x,z=t.y,d=t.z,y=Math.acos((g*x+u*z+v*d)/Math.sqrt((g*g+u*u+v*v)*(x*x+z*z+d*d))),j={x:m,y:b,z:f,angle:y};return j}},BGem3.Math=new BGem3.MathFunc;