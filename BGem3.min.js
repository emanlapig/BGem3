var BGem3={};BGem3.Scene=function(){this.objs=[],this.add=function(e){this.objs.push(e)},this.action=function(){}},BGem3.Camera=function(){this.position={x:0,y:0,z:0},this.focalLength=focalLength},BGem3.Obj3D=function(e){this.mesh=e,this.transform=[],this.vertices2=[],this.sgPosition={x:0,y:0,z:0},this.gPosition={x:0,y:0,z:0},this.lPosition={x:0,y:0,z:0},this.gRotation={x:0,y:0,z:0},this.lRotation={x:0,y:0,z:0},this.applyGlobalRot=!1,this.lockRotation=!1,this.visible=!0,this.shade=!0,this.shine=!0},BGem3.Mesh=function(){this.vertices=[],this.faces=[],this.transform=[],this.makeTransform=function(){this.transform=JSON.parse(JSON.stringify(this.vertices))},this.stroke=!0,this.strokeStyle="",this.fill=!1,this.fillStyle="",this.textured=!1},BGem3.CubeMesh=function(e){BGem3.Mesh.apply(this,arguments),this.size=e.size,this.vertices=[{x:.1,y:.1,z:.1},{x:this.size,y:-this.size,z:-this.size},{x:-this.size,y:-this.size,z:-this.size},{x:-this.size,y:this.size,z:-this.size},{x:this.size,y:this.size,z:-this.size},{x:this.size,y:-this.size,z:this.size},{x:-this.size,y:-this.size,z:this.size},{x:-this.size,y:this.size,z:this.size},{x:this.size,y:this.size,z:this.size}],this.faces=[[1,2,3,4,[102,45,145,1],!0,texture,!0],[5,1,4,8,[102,45,145,1],!0,texture,!1],[6,5,8,7,[102,45,145,1],!0,texture,!1],[2,6,7,3,[102,45,145,1],!0,texture,!1],[5,6,2,1,[102,45,145,1],!0,texture,!1],[4,3,7,8,[102,45,145,1],!0,texture,!1]],this.makeTransform()},BGem3.CubeMesh.prototype=new BGem3.Mesh,BGem3.AnchorPt=function(){BGem3.Mesh.apply(this,arguments),this.size=6,this.vertices=[{x:.1,y:.1,z:.1},{x:-this.size,y:-this.size,z:-this.size},{x:-this.size,y:this.size,z:-this.size},{x:this.size,y:this.size,z:-this.size},{x:this.size,y:-this.size,z:-this.size}],this.faces=[[4,1,2,3,[102,45,145,1],!0,texture,!0]],this.makeTransform(),this.lockRotation=!0},BGem3.AnchorPt.prototype=new BGem3.Mesh,BGem3.Renderer=function(){this.fps=fps,this.interval=1/this.fps*1e3,this.centerX=maxWidth/2,this.centerY=maxHeight/2,this.render=function(){for(var e=0;e<scene.objs.length;e++){renderer.debug=[],scene.objs[e].transform=[],scene.objs[e].vertices2=[];for(var s=0;s<scene.objs[e].mesh.vertices.length;s++){var t=JSON.parse(JSON.stringify(scene.objs[e].mesh.transform[s]));scene.objs[e].transform.push(t)}scene.objs[e].mesh.transform=[];for(var r=0;r<scene.objs[e].mesh.vertices.length;r++){var t=JSON.parse(JSON.stringify(scene.objs[e].transform[r]));scene.objs[e].mesh.transform.push(t)}}scene.action(),renderer.rotate("local",renderer.translate),renderer.trackFPS+=1},this.rotate=function(e,s){for(var t=0;t<scene.objs.length;t++){for(var r=0;r<scene.objs[t].transform.length;r++){var o=scene.objs[t].transform[r].y,n=scene.objs[t].transform[r].z,i=BGem3.Math.getAngle(0,0,o,n),a="local"==e?i-scene.objs[t].lRotation.x*Math.PI/180:i-scene.objs[t].gRotation.x*Math.PI/180;a>2*Math.PI&&(a-=2*Math.PI);var h=BGem3.Math.getDist(0,0,o,n);"local"==e?(scene.objs[t].mesh.transform[r].y=Math.cos(a)*h,scene.objs[t].mesh.transform[r].z=Math.sin(a)*h):(scene.objs[t].transform[r].y=Math.cos(a)*h,scene.objs[t].transform[r].z=Math.sin(a)*h)}for(var c=0;c<scene.objs[t].transform.length;c++){var l=scene.objs[t].transform[c].x,n=scene.objs[t].transform[c].z,i=BGem3.Math.getAngle(0,0,l,n),a="local"==e?i-scene.objs[t].lRotation.y*Math.PI/180:i-scene.objs[t].gRotation.y*Math.PI/180;a>2*Math.PI&&(a-=2*Math.PI);var h=BGem3.Math.getDist(0,0,l,n);"local"==e?(scene.objs[t].mesh.transform[c].x=Math.cos(a)*h,scene.objs[t].mesh.transform[c].z=Math.sin(a)*h):(scene.objs[t].transform[c].x=Math.cos(a)*h,scene.objs[t].transform[c].z=Math.sin(a)*h)}for(var f=0;f<scene.objs[t].transform.length;f++){var l=scene.objs[t].transform[f].x,o=scene.objs[t].transform[f].y,i=BGem3.Math.getAngle(0,0,l,o),a="local"==e?i-scene.objs[t].lRotation.z*Math.PI/180:i-scene.objs[t].gRotation.z*Math.PI/180;a>2*Math.PI&&(a-=2*Math.PI);var h=BGem3.Math.getDist(0,0,l,o);"local"==e?(scene.objs[t].mesh.transform[f].x=Math.cos(a)*h,scene.objs[t].mesh.transform[f].y=Math.sin(a)*h):(scene.objs[t].transform[f].x=Math.cos(a)*h,scene.objs[t].transform[f].y=Math.sin(a)*h)}if("global"==e&&scene.objs[t].applyGlobalRot){scene.objs[t].mesh.transform=[];for(var m=0;m<scene.objs[t].transform.length;m++)scene.objs[t].mesh.transform.push(JSON.parse(JSON.stringify(scene.objs[t].transform[m])));scene.objs[t].gRotation={x:0,y:0,z:0},scene.objs[t].lRotation={x:0,y:0,z:0},scene.objs[t].applyGlobalRot=!1}}if("local"==e)s("local",renderer.rotate);else{for(var t=0;t<scene.objs.length;t++)scene.objs[t].lPosition={x:0,y:0,z:0};s("global",renderer.project)}},this.translate=function(e,s){for(var t=0;t<scene.objs.length;t++)for(var r=0;r<scene.objs[t].transform.length;r++)"local"==e?(scene.objs[t].mesh.transform[r].x+=scene.objs[t].lPosition.x,scene.objs[t].mesh.transform[r].y+=scene.objs[t].lPosition.y,scene.objs[t].mesh.transform[r].z+=scene.objs[t].lPosition.z):(scene.objs[t].transform[r].x+=scene.objs[t].gPosition.x,scene.objs[t].transform[r].y+=scene.objs[t].gPosition.y,scene.objs[t].transform[r].z+=scene.objs[t].gPosition.z);if("local"==e)s("global",renderer.translate);else{for(var t=0;t<scene.objs.length;t++)if(scene.objs[t].sgPosition.x=JSON.parse(JSON.stringify(scene.objs[t])).transform[0].x,scene.objs[t].sgPosition.y=JSON.parse(JSON.stringify(scene.objs[t])).transform[0].y,scene.objs[t].sgPosition.z=JSON.parse(JSON.stringify(scene.objs[t])).transform[0].z,scene.objs[t].mesh.lockRotation)for(var r=1;r<scene.objs[t].transform.length;r++)scene.objs[t].transform[r].x=scene.objs[t].mesh.vertices[r].x+scene.objs[t].sgPosition.x,scene.objs[t].transform[r].y=scene.objs[t].mesh.vertices[r].y+scene.objs[t].sgPosition.y,scene.objs[t].transform[r].z=scene.objs[t].mesh.vertices[r].z+scene.objs[t].sgPosition.z;s(renderer.zSortObjs)}},this.project=function(e){for(var s=0;s<scene.objs.length;s++)for(var t=0;t<scene.objs[s].transform.length;t++){var r=camera.focalLength/scene.objs[s].transform[t].z,o={};o.x=scene.objs[s].transform[t].x*r+renderer.centerX,o.y=scene.objs[s].transform[t].y*r+renderer.centerY,scene.objs[s].vertices2.push(o)}e(renderer.draw)},this.zSort=[],this.zSortObjs=function(e){renderer.zSort=[];for(var s=0;s<scene.objs.length;s++)for(var t=0;t<scene.objs[s].mesh.faces.length;t++){var r=JSON.parse(JSON.stringify(scene.objs[s].transform)),o=JSON.parse(JSON.stringify(scene.objs[s].vertices2)),n=JSON.parse(JSON.stringify(scene.objs[s].mesh.faces[t])),i=JSON.parse(JSON.stringify(scene.objs[s].mesh.faces[t][4])),a=scene.objs[s].mesh.faces[t][7]&&scene.objs[s].mesh.textured,h={},c={},l={},f={},m=[h,c,l,f];h.v3=r[n[0]],h.v2=o[n[0]],h.v2.u=640,h.v2.v=0,c.v3=r[n[1]],c.v2=o[n[1]],c.v2.u=0,c.v2.v=0,l.v3=r[n[2]],l.v2=o[n[2]],l.v2.u=0,l.v2.v=360,f.v3=r[n[3]],f.v2=o[n[3]],f.v2.u=640,f.v2.v=360;for(var b=0,v=0;v<m.length;v++)b+=m[v].v3.z;var u=scene.objs[s].visible,g={obj:scene.objs[s],face:n,p1:h,p2:c,p3:l,p4:f,zInd:b,visible:u,fillStyle:i,cull:!1,textured:a};renderer.zSort.push(g)}renderer.zSort.sort(function(e,s){return s.zInd-e.zInd}),e(renderer.updateStats)},this.draw=function(e){if(renderer.skip)return void(renderer.skip=!1);ctx.clearRect(0,0,maxWidth,maxHeight);for(var s=0;s<renderer.zSort.length;s++)if(renderer.zSort[s].visible&&(renderer.backfaceCull(renderer.zSort[s]),!renderer.zSort[s].cull)){var t=BGem3.Math.getNormal(renderer.zSort[s]),r=t.angle,o=1-r/Math.PI,n=1-r/Math.PI*1.2,i=renderer.zSort[s].fillStyle,a=[renderer.zSort[s].p1.v2,renderer.zSort[s].p2.v2,renderer.zSort[s].p3.v2,renderer.zSort[s].p4.v2];ctx.save(),ctx.beginPath(),ctx.moveTo(a[0].x,a[0].y),ctx.lineTo(a[1].x,a[1].y),ctx.lineTo(a[2].x,a[2].y),ctx.lineTo(a[3].x,a[3].y),ctx.lineTo(a[0].x,a[0].y),ctx.closePath();var h=Math.floor(i[0]*o)+Math.floor(i[0]*n+50*n),c=Math.floor(i[1]*o)+Math.floor(i[1]*n+50*n),l=Math.floor(i[2]*o)+Math.floor(i[2]*n+50*n);ctx.strokeStyle="rgb("+h+","+c+","+l+")",ctx.stroke();var h=Math.floor(i[0]*o)+Math.floor(i[0]*n+50*n),c=Math.floor(i[1]*o)+Math.floor(i[1]*n+50*n),l=Math.floor(i[2]*o)+Math.floor(i[2]*n+50*n);if(ctx.fillStyle="rgb("+h+","+c+","+l+")",ctx.fill(),renderer.zSort[s].textured){a=renderer.overDraw(a),ctx.clip();for(var f=[[0,1,3],[1,2,3]],m=0;m<f.length;m++){var b=f[m],v=b[0],u=b[1],g=b[2],j=a[v].x,z=a[u].x,x=a[g].x,y=a[v].y,d=a[u].y,p=a[g].y,M=a[v].u,S=a[u].u,P=a[g].u,G=a[v].v,B=a[u].v,O=a[g].v,N=M*B+G*P+S*O-B*P-G*S-M*O,k=j*B+G*x+z*O-B*x-G*z-j*O,I=M*z+j*P+S*x-z*P-j*S-M*x,J=M*B*x+G*z*P+j*S*O-j*B*P-G*S*x-M*z*O,R=y*B+G*p+d*O-B*p-G*d-y*O,X=M*d+y*P+S*p-d*P-y*S-M*p,Y=M*B*p+G*d*P+y*S*O-y*B*P-G*S*p-M*d*O;ctx.transform(k/N,R/N,I/N,X/N,J/N,Y/N),ctx.drawImage(texture,0,0)}ctx.restore()}}e(renderer.post)},this.skip=!0,this.debug=[],this.updateStats=function(e){for(var s="",t=0;t<renderer.debug.length;t++)s+=renderer.debug[t][0]+": "+renderer.debug[t][1]+"<br>";$("#debug").html(s),e()},this.showFPS=!0,this.updateFPS=function(){updateFPS=setInterval(function(){var e="fps: "+renderer.trackFPS;$("#fps").html(e),renderer.trackFPS=0},1e3)},this.trackFPS=0,this.showFPS&&this.updateFPS(),this.backfaceCull=function(e){var s=e.p1.v2,t=e.p2.v2,r=e.p3.v2,o=t.x-s.x,n=t.y-s.y,i=t.x-r.x,a=t.y-r.y,h=o*a-n*i;e.cull=0>h?!0:!1},this.overDraw=function(e){for(var e=e,s=1.05,t=e[0],r=e[1],o=(e[2],e[3],e[2].x-e[0].x),n=e[2].y-e[0].y,i=e[3].x-e[1].x,a=e[3].y-e[1].y,h=n/o,c=a/i,l=t.y-h*t.x,f=r.y-c*r.x,m=(f-l)/(h-c),b=h*m+l,v=0;v<e.length;v++){var u=BGem3.Math.getDist(m,b,e[v].x,e[v].y),g=BGem3.Math.getAngle(m,b,e[v].x,e[v].y),j=u*s;e[v].x=m+Math.cos(g)*j,e[v].y=b+Math.sin(g)*j}return e},this.post=function(){}},BGem3.Controller=function(e){this.div=e.div,this.mouseX=0,this.mouseY=0,this.events={desktop:["mousedown","mousemove","mouseup"],mobile:["touchstart","touchmove","touchend"]},this.bindEvents=function(e){var s="desktop"==e,t=s?this.events.desktop:this.events.mobile;$(this.div).bind(t[0],function(e){controller.mouseX=s?e.pageX:e.originalEvent.touches[0].pageX,controller.mouseY=s?e.pageY:e.originalEvent.touches[0].pageY,$(this).bind(t[1],function(e){for(var t=s?e.pageX-controller.mouseX:e.originalEvent.touches[0].pageX-controller.mouseX,r=s?e.pageY-controller.mouseY:e.originalEvent.touches[0].pageY-controller.mouseY,o=0;o<scene.objs.length;o++)scene.objs[o].gRotation.y-=t/2,scene.objs[o].gRotation.x-=r/2;controller.mouseX=s?e.pageX:e.originalEvent.touches[0].pageX,controller.mouseY=s?e.pageY:e.originalEvent.touches[0].pageY}).bind(t[2],function(){$(this).unbind(t[1]);for(var e=0;e<scene.objs.length;e++)scene.objs[e].applyGlobalRot=!0})})},this.bindEvents("desktop"),this.bindEvents("mobile")},BGem3.MathFunc=function(){this.getDist=function(e,s,t,r){var o=e-t,n=s-r,i=Math.sqrt(o*o+n*n);return i},this.getAngle=function(e,s,t,r){var o;return t>=e&&r>=s?o=Math.atan((r-s)/(t-e)):e>=t&&r>=s?o=.5*Math.PI-Math.atan((t-e)/(r-s)):e>=t&&s>=r?o=Math.PI+Math.atan((r-s)/(t-e)):t>=e&&s>=r&&(o=1.5*Math.PI-Math.atan((t-e)/(r-s))),o},this.round2=function(e){return Math.round(100*(e+1e-5))/100},this.random=function(e,s){var t=s-e;return Math.floor(Math.random()*t+e)},this.getNormal=function(e){var s={x:100,y:-200,z:50},t=e.p1,r=e.p2,o=e.p3,n=r.v3.x-t.v3.x,i=r.v3.y-t.v3.y,a=r.v3.z-t.v3.z,h=o.v3.x-t.v3.x,c=o.v3.y-t.v3.y,l=r.v3.z-t.v3.z,f=i*l-a*c,m=a*h-n*l,b=n*c-i*h,v=f+.01,u=m+.01,g=b+.01,j=s.x,z=s.y,x=s.z,y=Math.acos((v*j+u*z+g*x)/Math.sqrt((v*v+u*u+g*g)*(j*j+z*z+x*x))),d={x:f,y:m,z:b,angle:y};return d}},BGem3.Math=new BGem3.MathFunc;